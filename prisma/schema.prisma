generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// A/B TESTING MODELS
// ============================================================================

model AbTestAssignment {
  id             String         @id
  testId         String         @map("test_id")
  variantId      String         @map("variant_id")
  recipientEmail String         @map("recipient_email")
  recipientId    String?        @map("recipient_id")
  assignedAt     DateTime       @default(now()) @map("assigned_at")
  abTestConfig   AbTestConfig   @relation(fields: [testId], references: [id], onDelete: Cascade)
  abTestEvents   AbTestEvent[]

  @@unique([testId, recipientEmail], map: "ab_test_assignments_test_id_recipient_email_key")
  @@index([recipientEmail])
  @@index([testId, variantId])
  @@map("ab_test_assignments")
}

model AbTestConfig {
  id                 String              @id
  name               String
  description        String?
  companyId          String              @map("company_id")
  variants           Json
  targetAudience     Json                @map("target_audience")
  successMetrics     Json                @map("success_metrics")
  minimumSampleSize  Int                 @default(1000) @map("minimum_sample_size")
  significanceLevel  Decimal             @default(0.05) @db.Decimal(3, 2) @map("significance_level")
  power              Decimal             @default(0.80) @db.Decimal(3, 2)
  status             String              @default("draft")
  startDate          DateTime            @map("start_date")
  endDate            DateTime?           @map("end_date")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @map("updated_at")
  abTestAssignments  AbTestAssignment[]
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([status, startDate])
  @@map("ab_test_config")
}

model AbTestEvent {
  id               String           @id
  testId           String           @map("test_id")
  assignmentId     String           @map("assignment_id")
  eventType        String           @map("event_type")
  eventData        Json?            @map("event_data")
  timestamp        DateTime         @default(now())
  abTestAssignment AbTestAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId, eventType])
  @@index([testId, eventType])
  @@index([timestamp])
  @@map("ab_test_events")
}

// ============================================================================
// AUTH MODELS (NextAuth)
// ============================================================================

model Account {
  id                String  @id
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refreshToken      String? @map("refresh_token")
  accessToken       String? @map("access_token")
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  idToken           String? @map("id_token")
  sessionState      String? @map("session_state")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// CORE BUSINESS MODELS
// ============================================================================

model Activity {
  id          String   @id
  companyId   String   @map("company_id")
  userId      String   @map("user_id")
  type        String
  description String
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activities")
}

model AuditLog {
  id             String    @id
  companyId      String    @map("company_id")
  userId         String?   @map("user_id")
  entityType     String    @map("entity_type")
  entityId       String    @map("entity_id")
  action         String
  oldValues      Json?     @map("old_values")
  newValues      Json?     @map("new_values")
  changedFields  String[]  @map("changed_fields")
  ipAddress      String?   @map("ip_address")
  userAgent      String?   @map("user_agent")
  sessionId      String?   @map("session_id")
  requestId      String?   @map("request_id")
  complianceFlag Boolean   @default(false) @map("compliance_flag")
  riskLevel      String    @default("LOW") @map("risk_level")
  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([action, createdAt])
  @@index([companyId, createdAt])
  @@index([companyId, entityType, action])
  @@index([companyId, entityType, createdAt])
  @@index([complianceFlag, riskLevel])
  @@index([createdAt, riskLevel])
  @@index([entityType, entityId])
  @@index([userId, action, createdAt])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

model BankReconciliation {
  id                 String    @id
  companyId          String    @map("company_id")
  bankAccount        String    @map("bank_account")
  statementDate      DateTime  @map("statement_date")
  statementRef       String?   @map("statement_ref")
  openingBalance     Decimal   @db.Decimal(12, 2) @map("opening_balance")
  closingBalance     Decimal   @db.Decimal(12, 2) @map("closing_balance")
  totalCredits       Decimal   @db.Decimal(12, 2) @map("total_credits")
  totalDebits        Decimal   @db.Decimal(12, 2) @map("total_debits")
  reconciledAmount   Decimal   @db.Decimal(12, 2) @map("reconciled_amount")
  unreconciledAmount Decimal   @db.Decimal(12, 2) @map("unreconciled_amount")
  status             String    @default("PENDING")
  reconciledBy       String?   @map("reconciled_by")
  reconciledAt       DateTime? @map("reconciled_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @map("updated_at")
  company            Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([bankAccount, statementDate])
  @@index([companyId, statementDate])
  @@index([reconciledBy, reconciledAt])
  @@index([status, createdAt])
  @@map("bank_reconciliation")
}

model BucketConfig {
  id               String    @id
  companyId        String    @map("company_id")
  bucketId         String    @map("bucket_id")
  autoSendEnabled  Boolean   @default(false) @map("auto_send_enabled")
  emailTemplateId  String?   @map("email_template_id")
  sendTimeHour     Int       @default(9) @map("send_time_hour")
  sendDaysOfWeek   Json      @default("[0, 1, 2, 3, 4]") @map("send_days_of_week")
  lastAutoSendAt   DateTime? @map("last_auto_send_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @map("updated_at")
  company          Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, bucketId])
  @@index([autoSendEnabled, lastAutoSendAt])
  @@index([companyId, autoSendEnabled])
  @@map("bucket_configs")
}

model Company {
  id                           String                        @id
  name                         String
  trn                          String?                       @unique
  address                      String?
  settings                     Json?                         @default("{}")
  createdAt                    DateTime                      @default(now()) @map("created_at")
  updatedAt                    DateTime                      @map("updated_at")
  businessHours                Json?                         @map("business_hours")
  defaultVatRate               Decimal?                      @default(5.00) @db.Decimal(5, 2) @map("default_vat_rate")
  emailSettings                Json?                         @map("email_settings")
  archivedAt                   DateTime?                     @map("archived_at")
  isActive                     Boolean                       @default(true) @map("is_active")
  abTestConfigs                AbTestConfig[]
  activities                   Activity[]
  auditLogs                    AuditLog[]
  bankReconciliations          BankReconciliation[]
  bucketConfigs                BucketConfig[]
  campaignEmailSends           CampaignEmailSend[]
  customerConsolidatedReminders CustomerConsolidatedReminder[]
  customers                    Customer[]
  emailLogs                    EmailLog[]
  emailSuppressionList         EmailSuppressionList[]
  emailTemplates               EmailTemplate[]
  followUpSequences            FollowUpSequence[]
  importBatches                ImportBatch[]
  invoiceCampaigns             InvoiceCampaign[]
  invoices                     Invoice[]
  users                        User[]

  @@index([isActive, createdAt])
  @@index([trn])
  @@map("companies")
}

model Customer {
  id                           String                        @id
  companyId                    String                        @map("company_id")
  name                         String
  email                        String
  phone                        String?
  paymentTerms                 Int?                          @default(30) @map("payment_terms")
  notes                        String?
  createdAt                    DateTime                      @default(now()) @map("created_at")
  updatedAt                    DateTime                      @map("updated_at")
  nameAr                       String?                       @map("name_ar")
  notesAr                      String?                       @map("notes_ar")
  address                      String?
  addressAr                    String?                       @map("address_ar")
  archivedAt                   DateTime?                     @map("archived_at")
  businessName                 String?                       @map("business_name")
  businessNameAr               String?                       @map("business_name_ar")
  businessType                 UaeBusinessType?              @map("business_type")
  communicationPref            String?                       @default("email") @map("communication_pref")
  contactPerson                String?                       @map("contact_person")
  contactPersonAr              String?                       @map("contact_person_ar")
  creditLimit                  Decimal?                      @db.Decimal(12, 2) @map("credit_limit")
  customerSince                DateTime?                     @map("customer_since")
  isActive                     Boolean                       @default(true) @map("is_active")
  lastInteraction              DateTime?                     @map("last_interaction")
  lastPaymentDate              DateTime?                     @map("last_payment_date")
  lifetimeValue                Decimal?                      @default(0.00) @db.Decimal(12, 2) @map("lifetime_value")
  outstandingBalance           Decimal?                      @default(0.00) @db.Decimal(12, 2) @map("outstanding_balance")
  paymentBehavior              Json?                         @default("{}") @map("payment_behavior")
  paymentMethodPref            String?                       @map("payment_method_pref")
  preferredLanguage            String?                       @default("en") @map("preferred_language")
  riskScore                    Decimal?                      @db.Decimal(3, 2) @map("risk_score")
  trn                          String?
  consolidationPreference      ConsolidationPreference       @default(ENABLED) @map("consolidation_preference")
  maxConsolidationAmount       Decimal?                      @db.Decimal(12, 2) @map("max_consolidation_amount")
  preferredContactInterval     Int                           @default(7) @map("preferred_contact_interval")
  customerConsolidatedReminders CustomerConsolidatedReminder[]
  company                      Company                       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  emailLogs                    EmailLog[]
  invoices                     Invoice[]

  @@unique([email, companyId])
  @@unique([trn, companyId])
  @@index([businessType, riskScore, companyId])
  @@index([companyId, businessType])
  @@index([companyId, businessType, isActive])
  @@index([companyId, createdAt, lifetimeValue])
  @@index([companyId, customerSince])
  @@index([companyId, email])
  @@index([companyId, isActive, createdAt])
  @@index([companyId, isActive, outstandingBalance])
  @@index([companyId, lastInteraction, isActive])
  @@index([companyId, lastPaymentDate])
  @@index([companyId, name])
  @@index([companyId, outstandingBalance])
  @@index([companyId, paymentTerms, riskScore])
  @@index([companyId, preferredLanguage, isActive])
  @@index([companyId, riskScore])
  @@index([companyId, trn])
  @@index([nameAr, businessNameAr])
  @@index([nameAr])
  @@index([name, email])
  @@index([name])
  @@index([phone])
  @@map("customers")
}

model Invoice {
  id                   String              @id
  companyId            String              @map("company_id")
  number               String
  customerName         String              @map("customer_name")
  customerEmail        String              @map("customer_email")
  amount               Decimal             @db.Decimal(10, 2)
  currency             String              @default("AED")
  dueDate              DateTime            @map("due_date")
  status               InvoiceStatus       @default(SENT)
  description          String?
  notes                String?
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @map("updated_at")
  descriptionAr        String?             @map("description_ar")
  importBatchId        String?             @map("import_batch_id")
  notesAr              String?             @map("notes_ar")
  subtotal             Decimal?            @db.Decimal(10, 2)
  totalAmount          Decimal?            @db.Decimal(10, 2) @map("total_amount")
  trnNumber            String?             @map("trn_number")
  vatAmount            Decimal?            @default(0.00) @db.Decimal(10, 2) @map("vat_amount")
  archivedAt           DateTime?           @map("archived_at")
  isActive             Boolean             @default(true) @map("is_active")
  lastReminderSent     DateTime?           @map("last_reminder_sent")
  paymentLink          String?             @map("payment_link")
  paymentIntentId      String?             @map("payment_intent_id")
  pdfS3Bucket          String?             @map("pdf_s3_bucket")
  pdfS3Key             String?             @map("pdf_s3_key")
  pdfUploadedAt        DateTime?           @map("pdf_uploaded_at")
  campaignEmailSends   CampaignEmailSend[]
  emailLogs            EmailLog[]
  followUpLogs         FollowUpLog[]
  invoiceItems         InvoiceItem[]
  company              Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer             Customer            @relation(fields: [customerEmail, companyId], references: [email, companyId])
  importBatch          ImportBatch?        @relation(fields: [importBatchId], references: [id])
  payments             Payment[]

  @@unique([companyId, number])
  @@index([companyId, createdAt])
  @@index([companyId, createdAt, totalAmount])
  @@index([companyId, currency, createdAt])
  @@index([companyId, currency, status])
  @@index([companyId, customerEmail, status])
  @@index([companyId, dueDate])
  @@index([companyId, isActive, createdAt])
  @@index([companyId, status, createdAt])
  @@index([companyId, status, dueDate])
  @@index([companyId, status, totalAmount])
  @@index([companyId, totalAmount])
  @@index([customerName, customerEmail])
  @@index([importBatchId])
  @@index([number, customerName])
  @@index([status, dueDate])
  @@index([trnNumber])
  @@map("invoices")
}

model InvoiceItem {
  id            String   @id
  invoiceId     String   @map("invoice_id")
  description   String
  quantity      Decimal  @db.Decimal(10, 2)
  unitPrice     Decimal  @db.Decimal(10, 2) @map("unit_price")
  total         Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  descriptionAr String?  @map("description_ar")
  taxCategory   String?  @default("STANDARD") @map("tax_category")
  totalWithVat  Decimal? @db.Decimal(10, 2) @map("total_with_vat")
  updatedAt     DateTime @map("updated_at")
  vatAmount     Decimal? @default(0.00) @db.Decimal(10, 2) @map("vat_amount")
  vatRate       Decimal? @default(5.00) @db.Decimal(5, 2) @map("vat_rate")
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([taxCategory])
  @@map("invoice_items")
}

model Payment {
  id                String        @id
  invoiceId         String        @map("invoice_id")
  amount            Decimal       @db.Decimal(10, 2)
  paymentDate       DateTime      @map("payment_date")
  method            PaymentMethod @default(BANK_TRANSFER)
  reference         String?
  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  bankReference     String?       @map("bank_reference")
  exchangeRate      Decimal?      @db.Decimal(10, 6) @map("exchange_rate")
  feesAmount        Decimal?      @default(0.00) @db.Decimal(10, 2) @map("fees_amount")
  isVerified        Boolean       @default(false) @map("is_verified")
  originalAmount    Decimal?      @db.Decimal(10, 2) @map("original_amount")
  originalCurrency  String?       @map("original_currency")
  reconciliationId  String?       @map("reconciliation_id")
  updatedAt         DateTime      @map("updated_at")
  verifiedAt        DateTime?     @map("verified_at")
  verifiedBy        String?       @map("verified_by")
  invoice           Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([bankReference])
  @@index([invoiceId, paymentDate])
  @@index([isVerified, paymentDate])
  @@index([method, isVerified])
  @@index([paymentDate, amount, method])
  @@index([paymentDate, method])
  @@index([reconciliationId])
  @@index([reference])
  @@index([verifiedBy, verifiedAt])
  @@map("payments")
}

model User {
  id                           String                        @id
  email                        String                        @unique
  name                         String
  password                     String?
  companyId                    String                        @map("company_id")
  role                         UserRole                      @default(FINANCE)
  createdAt                    DateTime                      @default(now()) @map("created_at")
  updatedAt                    DateTime                      @map("updated_at")
  resetToken                   String?                       @map("reset_token")
  resetTokenExpiry             DateTime?                     @map("reset_token_expiry")
  accounts                     Account[]
  activities                   Activity[]
  customerConsolidatedReminders CustomerConsolidatedReminder[]
  emailTemplates               EmailTemplate[]
  importBatches                ImportBatch[]
  sessions                     Session[]
  company                      Company                       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("users")
}

// ============================================================================
// EMAIL & CAMPAIGN MODELS
// ============================================================================

model CampaignEmailSend {
  id              String          @id
  campaignId      String          @map("campaign_id")
  companyId       String          @map("company_id")
  invoiceId       String          @map("invoice_id")
  customerId      String?         @map("customer_id")
  recipientEmail  String          @map("recipient_email")
  emailSubject    String          @map("email_subject")
  emailContent    String          @map("email_content")
  deliveryStatus  String          @default("pending") @map("delivery_status")
  sesMessageId    String?         @map("ses_message_id")
  errorMessage    String?         @map("error_message")
  sentAt          DateTime?       @map("sent_at")
  deliveredAt     DateTime?       @map("delivered_at")
  bouncedAt       DateTime?       @map("bounced_at")
  language        String          @default("ENGLISH")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @map("updated_at")
  invoiceCampaign InvoiceCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice         Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([campaignId, deliveryStatus])
  @@index([companyId])
  @@index([deliveryStatus])
  @@index([invoiceId])
  @@index([sentAt])
  @@map("campaignEmailSend")
}

model CustomerConsolidatedReminder {
  id                       String              @id
  customerId               String              @map("customer_id")
  companyId                String              @map("company_id")
  invoiceIds               String[]            @map("invoice_ids")
  totalAmount              Decimal             @db.Decimal(12, 2) @map("total_amount")
  currency                 String              @default("AED")
  invoiceCount             Int                 @map("invoice_count")
  reminderType             ReminderType        @default(CONSOLIDATED) @map("reminder_type")
  escalationLevel          EscalationLevel     @default(POLITE) @map("escalation_level")
  templateId               String?             @map("template_id")
  scheduledFor             DateTime?           @map("scheduled_for")
  sentAt                   DateTime?           @map("sent_at")
  deliveryStatus           EmailDeliveryStatus @default(QUEUED) @map("delivery_status")
  awsMessageId             String?             @map("aws_message_id")
  lastContactDate          DateTime?           @map("last_contact_date")
  nextEligibleContact      DateTime?           @map("next_eligible_contact")
  contactIntervalDays      Int                 @default(7) @map("contact_interval_days")
  priorityScore            Int                 @default(0) @map("priority_score")
  consolidationReason      String?             @map("consolidation_reason")
  businessRulesApplied     Json?               @default("{}") @map("business_rules_applied")
  culturalComplianceFlags  Json?               @default("{}") @map("cultural_compliance_flags")
  emailOpenedAt            DateTime?           @map("email_opened_at")
  emailClickedAt           DateTime?           @map("email_clicked_at")
  customerRespondedAt      DateTime?           @map("customer_responded_at")
  paymentReceivedAt        DateTime?           @map("payment_received_at")
  createdAt                DateTime            @default(now()) @map("created_at")
  updatedAt                DateTime            @map("updated_at")
  createdBy                String?             @map("created_by")
  company                  Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                     User?               @relation(fields: [createdBy], references: [id])
  customer                 Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  emailTemplate            EmailTemplate?      @relation(fields: [templateId], references: [id])
  emailLogs                EmailLog[]

  @@index([companyId, createdAt])
  @@index([companyId, deliveryStatus, priorityScore])
  @@index([companyId, deliveryStatus])
  @@index([companyId, escalationLevel, deliveryStatus])
  @@index([companyId, priorityScore])
  @@index([companyId, reminderType, escalationLevel])
  @@index([companyId, sentAt])
  @@index([customerId, companyId])
  @@index([customerId, nextEligibleContact])
  @@index([customerId, sentAt, deliveryStatus])
  @@index([scheduledFor, deliveryStatus])
  @@map("customer_consolidated_reminders")
}

model EmailBounceTracking {
  id             String   @id
  emailLogId     String   @unique @map("email_log_id")
  bounceType     String   @map("bounce_type")
  bounceSubtype  String?  @map("bounce_subtype")
  diagnosticCode String?  @map("diagnostic_code")
  feedbackId     String?  @map("feedback_id")
  arrivalDate    DateTime @map("arrival_date")
  isSuppressed   Boolean  @default(false) @map("is_suppressed")
  createdAt      DateTime @default(now()) @map("created_at")
  emailLog       EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)

  @@index([arrivalDate])
  @@index([bounceType, isSuppressed])
  @@map("email_bounce_tracking")
}

model EmailLog {
  id                         String                        @id
  templateId                 String?                       @map("template_id")
  companyId                  String                        @map("company_id")
  invoiceId                  String?                       @map("invoice_id")
  customerId                 String?                       @map("customer_id")
  followUpLogId              String?                       @map("follow_up_log_id")
  recipientEmail             String                        @map("recipient_email")
  recipientName              String?                       @map("recipient_name")
  subject                    String
  content                    String
  language                   EmailLanguage                 @default(ENGLISH)
  deliveryStatus             EmailDeliveryStatus           @default(QUEUED) @map("delivery_status")
  sentAt                     DateTime?                     @map("sent_at")
  deliveredAt                DateTime?                     @map("delivered_at")
  openedAt                   DateTime?                     @map("opened_at")
  clickedAt                  DateTime?                     @map("clicked_at")
  bouncedAt                  DateTime?                     @map("bounced_at")
  complainedAt               DateTime?                     @map("complained_at")
  unsubscribedAt             DateTime?                     @map("unsubscribed_at")
  awsMessageId               String?                       @map("aws_message_id")
  awsRequestId               String?                       @map("aws_request_id")
  bounceReason               String?                       @map("bounce_reason")
  complaintFeedback          String?                       @map("complaint_feedback")
  engagementScore            Decimal?                      @db.Decimal(3, 2) @map("engagement_score")
  uaeSendTime                DateTime?                     @map("uae_send_time")
  retryCount                 Int                           @default(0) @map("retry_count")
  maxRetries                 Int                           @default(3) @map("max_retries")
  createdAt                  DateTime                      @default(now()) @map("created_at")
  updatedAt                  DateTime                      @map("updated_at")
  consolidatedReminderId     String?                       @map("consolidated_reminder_id")
  consolidationMetadata      Json?                         @default("{}") @map("consolidation_metadata")
  consolidationSavings       Decimal?                      @default(0.00) @db.Decimal(5, 2) @map("consolidation_savings")
  invoiceCount               Int                           @default(1) @map("invoice_count")
  emailBounceTracking        EmailBounceTracking?
  company                    Company                       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  consolidatedReminder       CustomerConsolidatedReminder? @relation(fields: [consolidatedReminderId], references: [id])
  customer                   Customer?                     @relation(fields: [customerId], references: [id])
  followUpLog                FollowUpLog?                  @relation(fields: [followUpLogId], references: [id])
  invoice                    Invoice?                      @relation(fields: [invoiceId], references: [id])
  emailTemplate              EmailTemplate?                @relation(fields: [templateId], references: [id])

  @@index([companyId, deliveredAt, openedAt, clickedAt])
  @@index([companyId, deliveryStatus])
  @@index([companyId, sentAt, invoiceCount, consolidationSavings])
  @@index([consolidatedReminderId, deliveryStatus])
  @@index([customerId, sentAt])
  @@index([deliveryStatus, createdAt])
  @@index([invoiceId, sentAt])
  @@index([recipientEmail, companyId])
  @@index([uaeSendTime])
  @@map("email_logs")
}

model EmailSuppressionList {
  id              String   @id
  emailAddress    String   @map("email_address")
  companyId       String   @map("company_id")
  suppressionType String   @map("suppression_type")
  reason          String
  suppressedAt    DateTime @default(now()) @map("suppressed_at")
  suppressedBy    String?  @map("suppressed_by")
  isActive        Boolean  @default(true) @map("is_active")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @map("updated_at")
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([emailAddress, companyId])
  @@index([companyId, isActive])
  @@index([emailAddress])
  @@index([suppressionType, isActive])
  @@map("email_suppression_list")
}

model EmailTemplate {
  id                           String                        @id
  companyId                    String                        @map("company_id")
  name                         String
  description                  String?
  templateType                 EmailTemplateType             @default(FOLLOW_UP) @map("template_type")
  subjectEn                    String                        @map("subject_en")
  subjectAr                    String?                       @map("subject_ar")
  contentEn                    String                        @map("content_en")
  contentAr                    String?                       @map("content_ar")
  variables                    Json?
  version                      Int                           @default(1)
  isActive                     Boolean                       @default(true) @map("is_active")
  isDefault                    Boolean                       @default(false) @map("is_default")
  uaeBusinessHoursOnly         Boolean                       @default(true) @map("uae_business_hours_only")
  createdBy                    String                        @map("created_by")
  createdAt                    DateTime                      @default(now()) @map("created_at")
  updatedAt                    DateTime                      @map("updated_at")
  consolidationVariables       Json?                         @default("{}") @map("consolidation_variables")
  maxInvoiceCount              Int                           @default(1) @map("max_invoice_count")
  supportsConsolidation        Boolean                       @default(false) @map("supports_consolidation")
  customerConsolidatedReminders CustomerConsolidatedReminder[]
  emailLogs                    EmailLog[]
  company                      Company                       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                         User                          @relation(fields: [createdBy], references: [id])

  @@unique([companyId, name, version])
  @@index([companyId, templateType, isActive])
  @@index([isDefault, templateType])
  @@index([templateType, maxInvoiceCount, isActive])
  @@index([templateType, supportsConsolidation, isActive])
  @@map("email_templates")
}

model FollowUpLog {
  id               String           @id
  invoiceId        String           @map("invoice_id")
  sequenceId       String           @map("sequence_id")
  stepNumber       Int              @map("step_number")
  emailAddress     String           @map("email_address")
  subject          String
  content          String
  sentAt           DateTime         @map("sent_at")
  emailOpened      DateTime?        @map("email_opened")
  emailClicked     DateTime?        @map("email_clicked")
  responseReceived DateTime?        @map("response_received")
  awsMessageId     String?          @map("aws_message_id")
  deliveryStatus   String?          @map("delivery_status")
  emailLogs        EmailLog[]
  invoice          Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  followUpSequence FollowUpSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@map("follow_up_logs")
}

model FollowUpSequence {
  id            String        @id
  companyId     String        @map("company_id")
  name          String
  steps         Json
  active        Boolean       @default(true)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @map("updated_at")
  followUpLogs  FollowUpLog[]
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("follow_up_sequences")
}

model InvoiceCampaign {
  id                    String              @id
  companyId             String              @map("company_id")
  name                  String
  emailSubject          String              @map("email_subject")
  emailContent          String              @map("email_content")
  language              String              @default("ENGLISH")
  templateId            String?             @map("template_id")
  status                String              @default("draft")
  totalRecipients       Int                 @default(0) @map("total_recipients")
  sentCount             Int                 @default(0) @map("sent_count")
  failedCount           Int                 @default(0) @map("failed_count")
  successRate           Int                 @default(0) @map("success_rate")
  batchSize             Int                 @default(5) @map("batch_size")
  delayBetweenBatches   Int                 @default(3000) @map("delay_between_batches")
  respectBusinessHours  Boolean             @default(true) @map("respect_business_hours")
  scheduledFor          DateTime?           @map("scheduled_for")
  startedAt             DateTime?           @map("started_at")
  completedAt           DateTime?           @map("completed_at")
  errorMessage          String?             @map("error_message")
  createdBy             String              @map("created_by")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @map("updated_at")
  attachInvoicePdf      Boolean             @default(true) @map("attach_invoice_pdf")
  campaignEmailSends    CampaignEmailSend[]
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([createdBy])
  @@index([scheduledFor])
  @@map("invoiceCampaign")
}

// ============================================================================
// IMPORT & DATA MANAGEMENT MODELS
// ============================================================================

model DataRetentionPolicy {
  id             String   @id
  entityType     String   @unique @map("entity_type")
  retentionDays  Int      @map("retention_days")
  archiveDays    Int      @map("archive_days")
  autoDeleteDays Int?     @map("auto_delete_days")
  isActive       Boolean  @default(true) @map("is_active")
  complianceRule String?  @map("compliance_rule")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @map("updated_at")

  @@index([entityType, isActive])
  @@map("data_retention_policies")
}

model DbPerformanceLog {
  id            String   @id
  queryType     String   @map("query_type")
  tableName     String   @map("table_name")
  executionTime Int      @map("execution_time")
  rowsAffected  Int?     @map("rows_affected")
  queryHash     String   @map("query_hash")
  slowQuery     Boolean  @default(false) @map("slow_query")
  companyId     String?  @map("company_id")
  userId        String?  @map("user_id")
  endpoint      String?
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([companyId, createdAt])
  @@index([queryHash, createdAt])
  @@index([queryType, createdAt])
  @@index([slowQuery, createdAt])
  @@index([tableName, executionTime])
  @@map("db_performance_logs")
}

model ImportBatch {
  id                   String                @id
  companyId            String                @map("company_id")
  userId               String                @map("user_id")
  filename             String
  originalFilename     String                @map("original_filename")
  fileSize             Int                   @map("file_size")
  totalRecords         Int                   @default(0) @map("total_records")
  processedRecords     Int                   @default(0) @map("processed_records")
  successfulRecords    Int                   @default(0) @map("successful_records")
  failedRecords        Int                   @default(0) @map("failed_records")
  status               ImportBatchStatus     @default(PENDING)
  importType           ImportType            @default(INVOICE) @map("import_type")
  fieldMappings        Json?                 @map("field_mappings")
  processingStartedAt  DateTime?             @map("processing_started_at")
  processingEndedAt    DateTime?             @map("processing_ended_at")
  errorSummary         String?               @map("error_summary")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @map("updated_at")
  company              Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  importErrors         ImportError[]
  importFieldMappings  ImportFieldMapping[]
  invoices             Invoice[]

  @@index([companyId, status])
  @@index([status, createdAt])
  @@index([userId, createdAt])
  @@map("import_batches")
}

model ImportError {
  id             String          @id
  importBatchId  String          @map("import_batch_id")
  rowNumber      Int             @map("row_number")
  csvData        Json            @map("csv_data")
  errorType      ImportErrorType @map("error_type")
  errorMessage   String          @map("error_message")
  fieldName      String?         @map("field_name")
  attemptedValue String?         @map("attempted_value")
  suggestion     String?
  isResolved     Boolean         @default(false) @map("is_resolved")
  resolvedAt     DateTime?       @map("resolved_at")
  resolvedBy     String?         @map("resolved_by")
  createdAt      DateTime        @default(now()) @map("created_at")
  importBatch    ImportBatch     @relation(fields: [importBatchId], references: [id], onDelete: Cascade)

  @@index([importBatchId, errorType])
  @@index([importBatchId, isResolved])
  @@index([rowNumber, importBatchId])
  @@map("import_errors")
}

model ImportFieldMapping {
  id             String      @id
  importBatchId  String      @map("import_batch_id")
  csvColumnName  String      @map("csv_column_name")
  systemField    String      @map("system_field")
  dataType       String      @map("data_type")
  isRequired     Boolean     @default(false) @map("is_required")
  defaultValue   String?     @map("default_value")
  validationRule String?     @map("validation_rule")
  transformation String?
  createdAt      DateTime    @default(now()) @map("created_at")
  importBatch    ImportBatch @relation(fields: [importBatchId], references: [id], onDelete: Cascade)

  @@unique([importBatchId, csvColumnName])
  @@index([importBatchId])
  @@map("import_field_mappings")
}

// ============================================================================
// ENUMS
// ============================================================================

enum ConsolidationPreference {
  ENABLED
  DISABLED
  AUTO
}

enum EmailDeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
  FAILED
}

enum EmailLanguage {
  ENGLISH
  ARABIC
}

enum EmailTemplateType {
  FOLLOW_UP
  WELCOME
  INVOICE_REMINDER
  PAYMENT_CONFIRMATION
  OVERDUE_NOTICE
  SYSTEM_NOTIFICATION
  CONSOLIDATED_REMINDER
  URGENT_CONSOLIDATED_REMINDER
}

enum EscalationLevel {
  POLITE
  FIRM
  URGENT
  FINAL
}

enum ImportBatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  PARTIALLY_COMPLETED
}

enum ImportErrorType {
  VALIDATION_ERROR
  FORMAT_ERROR
  DUPLICATE_ERROR
  REFERENCE_ERROR
  CONSTRAINT_ERROR
  BUSINESS_RULE_ERROR
}

enum ImportType {
  INVOICE
  CUSTOMER
  PAYMENT
  INVOICE_ITEMS
}

enum InvoiceStatus {
  DRAFT
  SENT
  OVERDUE
  PAID
  DISPUTED
  WRITTEN_OFF
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  CASH
  CHEQUE
  OTHER
}

enum ReminderType {
  CONSOLIDATED
  URGENT_CONSOLIDATED
  FINAL_CONSOLIDATED
  MANUAL_CONSOLIDATED
}

enum UaeBusinessType {
  LLC
  FREE_ZONE
  SOLE_PROPRIETORSHIP
  PARTNERSHIP
  BRANCH
  PUBLIC_SHAREHOLDING_COMPANY
  PRIVATE_SHAREHOLDING_COMPANY
  GOVERNMENT_ENTITY
}

enum UserRole {
  ADMIN
  FINANCE
  VIEWER
}
